# src/evaluation/metrics.py é—®é¢˜å®šä½å›¾

## æ–‡ä»¶ç»“æ„ä¸é—®é¢˜åˆ†å¸ƒ

```
src/evaluation/metrics.py (425è¡Œ)
â”‚
â”œâ”€â”€ [è¡Œ1-22] å¯¼å…¥å’Œæ–‡æ¡£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é—®é¢˜: ç¼ºå°‘ F.one_hot å¯¼å…¥                                    â”‚
â”‚   ä¿®å¤: æ·»åŠ  import torch.nn.functional as F                  â”‚
â”‚                                                                â”‚
â”œâ”€â”€ [è¡Œ24-90] reconstruction_metrics() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚                                                            â”‚
â”‚   â”œâ”€â”€ [è¡Œ64-76] âœ… Pearson/Spearmanå¾ªç¯è®¡ç®—ï¼ˆæ­£ç¡®ï¼‰           â”‚
â”‚   â”‚                                                            â”‚
â”‚   â””â”€â”€ [è¡Œ79-81] ğŸ”µ RÂ² scoreè®¡ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       é—®é¢˜: å…¨å±€RÂ²ï¼Œè¯­ä¹‰ä¸æ¸…æ™°                                â”‚
â”‚       å½±å“: ä½ï¼ˆé€»è¾‘æ­£ç¡®ä½†å¯èƒ½ä¸ç¬¦åˆé¢„æœŸï¼‰                    â”‚
â”‚       ä¿®å¤: æ”¹ä¸ºper-gene RÂ²æˆ–æ·»åŠ æ˜ç¡®æ³¨é‡Š                     â”‚
â”‚                                                                â”‚
â”œâ”€â”€ [è¡Œ93-144] distribution_metrics() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚                                                            â”‚
â”‚   â”œâ”€â”€ [è¡Œ126-128] âœ… E-distanceè®¡ç®—ï¼ˆæ­£ç¡®ï¼‰                   â”‚
â”‚   â”‚                                                            â”‚
â”‚   â”œâ”€â”€ [è¡Œ131-134] âœ… å‡å€¼è·ç¦»ï¼ˆæ­£ç¡®ï¼‰                         â”‚
â”‚   â”‚                                                            â”‚
â”‚   â””â”€â”€ [è¡Œ136-142] ğŸ”´ åæ–¹å·®è·ç¦» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       è¡Œ139: cov_true = ... / (z_true.shape[0] - 1)          â”‚
â”‚       è¡Œ140: cov_pred = ... / (z_pred.shape[0] - 1)          â”‚
â”‚       é—®é¢˜: batch_size=1æ—¶é™¤é›¶                                â”‚
â”‚       å½±å“: é«˜ï¼ˆäº§ç”ŸNaNï¼‰                                     â”‚
â”‚       ä¿®å¤: n = max(shape[0] - 1, 1)                          â”‚
â”‚                                                                â”‚
â”œâ”€â”€ [è¡Œ147-251] de_gene_prediction_metrics() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚                                                            â”‚
â”‚   â”œâ”€â”€ [è¡Œ198-205] ğŸŸ¡ log2FCè®¡ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚   è¡Œ200: mean_x0 = x0_np.mean(axis=0) + eps              â”‚
â”‚   â”‚   è¡Œ201: mean_x1_true = x1_true_np.mean(axis=0) + eps    â”‚
â”‚   â”‚   è¡Œ202: mean_x1_pred = x1_pred_np.mean(axis=0) + eps    â”‚
â”‚   â”‚   è¡Œ204: log2fc_true = np.log2(mean_x1_true / mean_x0)   â”‚
â”‚   â”‚   è¡Œ205: log2fc_pred = np.log2(mean_x1_pred / mean_x0)   â”‚
â”‚   â”‚   é—®é¢˜: pseudocountæ·»åŠ åœ¨å‡å€¼ä¹‹åï¼Œå¼•å…¥bias               â”‚
â”‚   â”‚   å½±å“: ä¸­ï¼ˆå½±å“DEåŸºå› æ’åºå‡†ç¡®æ€§ï¼‰                        â”‚
â”‚   â”‚   ä¿®å¤: log2((mean + eps) / (mean + eps))                â”‚
â”‚   â”‚                                                            â”‚
â”‚   â”œâ”€â”€ [è¡Œ212-219] âœ… Jaccardè®¡ç®—ï¼ˆæ­£ç¡®ï¼‰                      â”‚
â”‚   â”‚                                                            â”‚
â”‚   â””â”€â”€ [è¡Œ225-243] âœ… AUROC/AUPRC/ç›¸å…³æ€§ï¼ˆæ­£ç¡®ï¼‰               â”‚
â”‚                                                                â”‚
â”œâ”€â”€ [è¡Œ254-315] operator_quality_metrics() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚                                                            â”‚
â”‚   â”œâ”€â”€ [è¡Œ295-297] âœ… è°±èŒƒæ•°è®¡ç®—ï¼ˆæ¥å£æ­£ç¡®ï¼‰                   â”‚
â”‚   â”‚                                                            â”‚
â”‚   â””â”€â”€ [è¡Œ300-314] âœ… å“åº”ç³»æ•°åˆ†æï¼ˆæ¥å£æ­£ç¡®ï¼‰                 â”‚
â”‚                                                                â”‚
â””â”€â”€ [è¡Œ318-424] comprehensive_evaluation() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚
    â”œâ”€â”€ [è¡Œ353-364] âœ… åˆå§‹åŒ–å’Œæ¨¡å‹è®¾ç½®ï¼ˆæ­£ç¡®ï¼‰                 â”‚
    â”‚
    â”œâ”€â”€ [è¡Œ366-394] ğŸ”´ğŸ”´ ä¸»å¾ªç¯ï¼ˆ2ä¸ªä¸¥é‡é”™è¯¯ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   â”‚                                                        â”‚
    â”‚   è¡Œ370: tissue_idx = batch["tissue_idx"].to(device)      â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚   â”‚ ç¼ºå¤±: tissue_onehot = F.one_hot(tissue_idx, ...)    â”‚ â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚   â”‚                                                        â”‚
    â”‚   è¡Œ374: mu0, _ = vae_model.encoder(x0, tissue_idx) â”€â”€â”€â”€â” â”‚
    â”‚   é—®é¢˜1: encoderéœ€è¦tissue_onehotè€Œä¸æ˜¯tissue_idx        â”‚ â”‚
    â”‚   å½±å“: é«˜ï¼ˆè¿è¡Œæ—¶ç»´åº¦é”™è¯¯ï¼‰                              â”‚ â”‚
    â”‚   ä¿®å¤: encoder(x0, tissue_onehot)                        â”‚ â”‚
    â”‚   â”‚                                                        â”‚
    â”‚   è¡Œ381: x1_pred = vae.decoder.get_mean(z1, tissue_idx)â”€â” â”‚
    â”‚   é—®é¢˜2: decoderæ²¡æœ‰get_meanæ–¹æ³•                          â”‚ â”‚
    â”‚   å½±å“: é«˜ï¼ˆAttributeErrorï¼‰                              â”‚ â”‚
    â”‚   ä¿®å¤: mu_x1, _ = decoder(z1, tissue_onehot); x1=mu_x1  â”‚ â”‚
    â”‚   â”‚                                                        â”‚
    â”‚   è¡Œ384: mu1, _ = vae_model.encoder(x1, tissue_idx) â”€â”€â”€â”€â” â”‚
    â”‚   é—®é¢˜1é‡å¤: åŒæ ·çš„æ¥å£ä¸åŒ¹é…                             â”‚ â”‚
    â”‚   â”‚                                                        â”‚
    â”‚   â””â”€â”€ [è¡Œ387-393] âœ… æ•°æ®æ”¶é›†ï¼ˆæ­£ç¡®ï¼‰                     â”‚
    â”‚                                                            â”‚
    â”œâ”€â”€ [è¡Œ396-402] âœ… æ•°æ®æ‹¼æ¥ï¼ˆæ­£ç¡®ï¼‰                         â”‚
    â”‚                                                            â”‚
    â””â”€â”€ [è¡Œ405-423] âœ… æŒ‡æ ‡è®¡ç®—ï¼ˆæ­£ç¡®ï¼‰                         â”‚
```

---

## é—®é¢˜ä¸¥é‡ç¨‹åº¦å›¾ä¾‹

- ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆP0ï¼‰ï¼šå¿…é¡»ç«‹å³ä¿®å¤ï¼Œå¦åˆ™ä»£ç æ— æ³•è¿è¡Œ
- ğŸŸ¡ é‡è¦é—®é¢˜ï¼ˆP1ï¼‰ï¼šå½±å“å‡†ç¡®æ€§ï¼Œå¼ºçƒˆå»ºè®®ä¿®å¤
- ğŸ”µ æ”¹è¿›å»ºè®®ï¼ˆP2ï¼‰ï¼šæå‡ä»£ç è´¨é‡
- âœ… æ­£å¸¸ï¼šæ— é—®é¢˜

---

## æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»

### ğŸ”´ P0 - é˜»å¡æ€§é—®é¢˜ï¼ˆ3ä¸ªï¼‰

1. **comprehensive_evaluation è¡Œ374**:
   - `vae_model.encoder(x0, tissue_idx)`
   - âŒ åº”ä¸º: `vae_model.encoder(x0, tissue_onehot)`

2. **comprehensive_evaluation è¡Œ381**:
   - `vae_model.decoder.get_mean(z1_pred, tissue_idx)`
   - âŒ åº”ä¸º: `mu_x1_pred, _ = vae_model.decoder(z1_pred, tissue_onehot); x1_pred = mu_x1_pred`

3. **comprehensive_evaluation è¡Œ384**:
   - `vae_model.encoder(x1, tissue_idx)`
   - âŒ åº”ä¸º: `vae_model.encoder(x1, tissue_onehot)`

4. **distribution_metrics è¡Œ139-140**:
   - `cov = ... / (z.shape[0] - 1)`
   - âŒ åº”ä¸º: `cov = ... / max(z.shape[0] - 1, 1)`

### ğŸŸ¡ P1 - å‡†ç¡®æ€§é—®é¢˜ï¼ˆ1ä¸ªï¼‰

5. **de_gene_prediction_metrics è¡Œ200-205**:
   - `mean_x0 = x0.mean() + eps; log2fc = log2(mean_x1 / mean_x0)`
   - âš ï¸ åº”ä¸º: `log2fc = log2((mean_x1 + eps) / (mean_x0 + eps))`

### ğŸ”µ P2 - æ”¹è¿›å»ºè®®ï¼ˆ2ä¸ªï¼‰

6. **reconstruction_metrics è¡Œ79-81**: RÂ²è¯­ä¹‰ä¸æ¸…æ™°
7. **æ‰€æœ‰å‡½æ•°**: ç¼ºå°‘è¾“å…¥ç»´åº¦éªŒè¯

---

## ä¿®å¤å·¥ä½œé‡ä¼°ç®—

| é—®é¢˜ | ä¿®æ”¹è¡Œæ•° | éš¾åº¦ | æ—¶é—´ä¼°è®¡ |
|------|----------|------|----------|
| é—®é¢˜1-3 (comprehensive_evaluation) | 4è¡Œ | ç®€å• | 5åˆ†é’Ÿ |
| é—®é¢˜4 (distribution_metrics) | 3è¡Œ | ç®€å• | 2åˆ†é’Ÿ |
| é—®é¢˜5 (de_gene_prediction_metrics) | 2è¡Œ | ç®€å• | 2åˆ†é’Ÿ |
| é—®é¢˜6 (reconstruction_metrics) | 5è¡Œ | ä¸­ç­‰ | 10åˆ†é’Ÿ |
| é—®é¢˜7 (è¾“å…¥éªŒè¯) | 20è¡Œ | ç®€å• | 15åˆ†é’Ÿ |
| **æ€»è®¡** | **34è¡Œ** | - | **34åˆ†é’Ÿ** |

---

## ä¿®å¤é¡ºåºå»ºè®®

```
æ­¥éª¤1 (å¿…é¡»): ä¿®å¤comprehensive_evaluation
  â”œâ”€ åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ : import torch.nn.functional as F
  â”œâ”€ åœ¨è¡Œ372åæ·»åŠ : tissue_onehot = F.one_hot(tissue_idx, ...).float()
  â”œâ”€ ä¿®æ”¹è¡Œ374: encoder(x0, tissue_onehot)
  â”œâ”€ ä¿®æ”¹è¡Œ381: mu_x1_pred, _ = decoder(z1_pred, tissue_onehot); x1_pred = mu_x1_pred
  â””â”€ ä¿®æ”¹è¡Œ384: encoder(x1, tissue_onehot)

æ­¥éª¤2 (å¿…é¡»): ä¿®å¤distribution_metrics
  â””â”€ ä¿®æ”¹è¡Œ139-140: ä½¿ç”¨max(shape[0]-1, 1)

æ­¥éª¤3 (å»ºè®®): ä¿®å¤de_gene_prediction_metrics
  â””â”€ ä¿®æ”¹è¡Œ204-205: log2((mean+eps)/(mean+eps))

æ­¥éª¤4 (å¯é€‰): æ”¹è¿›reconstruction_metricså’Œæ·»åŠ è¾“å…¥éªŒè¯
```

---

## ä»£ç å·®å¼‚é¢„è§ˆ

### ä¿®å¤åçš„comprehensive_evaluationæ ¸å¿ƒéƒ¨åˆ†ï¼š

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
for batch in dataloader:
    x0 = batch["x0"].to(device)
    x1 = batch["x1"].to(device)
    tissue_idx = batch["tissue_idx"].to(device)
    cond_vec = batch["cond_vec"].to(device)

    mu0, _ = vae_model.encoder(x0, tissue_idx)  # âŒ
    z0 = mu0
    z1_pred = operator_model(z0, tissue_idx, cond_vec)
    x1_pred = vae_model.decoder.get_mean(z1_pred, tissue_idx)  # âŒ
    mu1, _ = vae_model.encoder(x1, tissue_idx)  # âŒ

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
for batch in dataloader:
    x0 = batch["x0"].to(device)
    x1 = batch["x1"].to(device)
    tissue_idx = batch["tissue_idx"].to(device)
    cond_vec = batch["cond_vec"].to(device)

    # è½¬æ¢ä¸ºone-hotç¼–ç 
    tissue_onehot = F.one_hot(tissue_idx, num_classes=vae_model.n_tissues).float()  # âœ…

    mu0, _ = vae_model.encoder(x0, tissue_onehot)  # âœ…
    z0 = mu0
    z1_pred = operator_model(z0, tissue_idx, cond_vec)
    mu_x1_pred, _ = vae_model.decoder(z1_pred, tissue_onehot)  # âœ…
    x1_pred = mu_x1_pred  # âœ…
    mu1, _ = vae_model.encoder(x1, tissue_onehot)  # âœ…
```

---

## æµ‹è¯•éªŒè¯ç‚¹

ä¿®å¤å®Œæˆåï¼ŒéªŒè¯ä»¥ä¸‹åœºæ™¯ï¼š

- [ ] æ­£å¸¸batchè¿è¡Œä¸æŠ¥é”™
- [ ] å•æ ·æœ¬batchä¸äº§ç”ŸNaN
- [ ] é›¶å€¼åŸºå› ä¸å¯¼è‡´log(0)
- [ ] æ‰€æœ‰æŒ‡æ ‡éƒ½åœ¨åˆç†èŒƒå›´å†…
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸ï¼ˆæ— æ³„æ¼ï¼‰

---

## ç›¸å…³æ–‡ä»¶

éœ€è¦åŒæ—¶å‚è€ƒçš„æ–‡ä»¶ï¼š
- `/home/user/xuni/src/models/nb_vae.py` (Encoderå’ŒDecoderNBçš„æ¥å£å®šä¹‰)
- `/home/user/xuni/src/models/operator.py` (OperatorModelçš„æ–¹æ³•)
- `/home/user/xuni/src/utils/edistance.py` (energy_distanceå‡½æ•°)

---

## æ€»ç»“

**å½“å‰çŠ¶æ€**: âŒ ä»£ç æ— æ³•è¿è¡Œï¼ˆ3ä¸ªä¸¥é‡æ¥å£é”™è¯¯ï¼‰

**ä¿®å¤åçŠ¶æ€**: âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ•°å€¼ç¨³å®š

**å…³é”®ä¿®å¤**:
1. æ·»åŠ tissue_onehotè½¬æ¢
2. ä¿®æ­£decoderè°ƒç”¨
3. æ·»åŠ é™¤é›¶ä¿æŠ¤
